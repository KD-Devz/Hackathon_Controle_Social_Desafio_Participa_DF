{% extends "base.html" %}

{% block title %}Relatório de Auditoria #{{ id }}{% endblock %}

{% block main %}
    <section class="content">
        <div style="text-align:center; margin-bottom:40px;">
            <span class="badge" style="background-color: var(--primary); color: white; padding: 8px 18px; border-radius: 20px; font-weight: 600;">
                Protocolo e-SIC #{{ id }}
            </span>
            <h2 style="color: var(--primary); font-weight: 700; margin-top: 15px;">Relatório de Auditoria de Privacidade</h2>
        </div>

        <div class="card-glow" style="--card-color: var(--primary); margin-bottom: 35px;">
            <div class="card-label">Conteúdo Analisado</div>
            <div style="background: rgba(255,255,255,0.5); padding: 20px; border-radius: 8px; border: 1px solid #eee; position: relative;">
                <p style="font-style: italic; font-size: 1.05rem; line-height: 1.8; color: var(--text-main); text-align: justify; margin: 0;">
                    <span style="font-size: 2rem; color: #cbd5e0; font-family: serif; line-height: 0; vertical-align: middle;">&ldquo;</span>
                    {{ texto }}
                    <span style="font-size: 2rem; color: #cbd5e0; font-family: serif; line-height: 0; vertical-align: middle;">&rdquo;</span>
                </p>
            </div>
        </div>

        {% if resposta %}
            {% set is_risco = resposta.STATUS == 'True' %}
            <div style="padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 35px;
                    background-color: {{ '#fff5f5' if is_risco else '#f0fff4' }};
                    border: 2px solid {{ 'var(--risco-severo)' if is_risco else 'var(--success)' }};">

                <h3 style="margin: 0; color: {{ 'var(--risco-severo)' if is_risco else 'var(--success)' }}; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    {% if is_risco %}
                        <i class="fas fa-exclamation-triangle"></i> RISCO DETECTADO
                    {% else %}
                        <i class="fas fa-shield-check"></i> CONTEÚDO SEGURO
                    {% endif %}
                </h3>
                <p class="muted" style="margin-top: 10px; font-weight: 500;">
                    {{ 'A análise identificou padrões que violam a política de privacidade (LGPD).' if is_risco else 'Esta solicitação está em conformidade com as normas de transparência ativa.' }}
                </p>
            </div>

            <div class="analysis-result">
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-tasks"></i> Indicadores de Auditoria</h3>
                <div class="impact-grid">

                    {# Nível de Risco - Dinâmico #}
                    {% set cor_risco = '#2baea9' if resposta.CRITICIDADE_NORM <= 0.2
                                  else '#f1c40f' if resposta.CRITICIDADE_NORM <= 0.4
                                  else '#e67e22' if resposta.CRITICIDADE_NORM <= 0.6
                                  else '#ed2131' %}

                    <div class="card-glow" style="--card-color: {{ cor_risco }};">
                        <div class="card-label">Nível de Risco</div>
                        <div class="card-value">{{ resposta.ADJETIVO }}</div>
                        <div class="card-icon-float"><i class="fas fa-biohazard"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.CRITICIDADE_NORM * 100)|round }}%;"></div>
                        </div>
                        <div class="card-footer-info">
                            <span>Índice: {{ (resposta.CRITICIDADE_NORM * 100)|round(1) }}%</span>
                            <span>Bruto: {{ resposta.CRITICIDADE }}</span>
                        </div>
                    </div>

                    <div class="card-glow" style="--card-color: var(--crit-linearidade);">
                        <div class="card-label">Linearidade</div>
                        <div class="card-value">{{ resposta.LINEARIDADE }}</div>
                        <div class="card-icon-float"><i class="fas fa-stream"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.LINEARIDADE * 10) if resposta.LINEARIDADE < 10 else 100 }}%;"></div>
                        </div>
                    </div>

                    <div class="card-glow" style="--card-color: var(--crit-identificadores);">
                        <div class="card-label">Identificadores</div>
                        <div class="card-value">{{ resposta.IDENTIFICADORES }}</div>
                        <div class="card-icon-float"><i class="fas fa-fingerprint"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.IDENTIFICADORES * 20) if resposta.IDENTIFICADORES < 5 else 100 }}%;"></div>
                        </div>
                    </div>

                    <div class="card-glow" style="--card-color: var(--crit-exigencias);">
                        <div class="card-label">Exigências</div>
                        <div class="card-value">{{ resposta.EXIGENCIAS }}</div>
                        <div class="card-icon-float"><i class="fas fa-gavel"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.EXIGENCIAS * 5) if resposta.EXIGENCIAS < 20 else 100 }}%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="analysis-result" style="margin-top: 40px;">
                <h4 style="margin-bottom: 20px; color: var(--text-main);"><i class="fas fa-list-ul"></i> Fragmentação e Termos Detectados</h4>
                <div style="overflow-x: auto;">
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Fragmento</th>
                                <th style="text-align: center;">Status</th>
                                <th style="text-align: center;">Sensíveis</th>
                                <th style="text-align: center;">Interrogativas</th>
                                <th style="text-align: center;">Nomes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for linha in resposta.linhas %}
                            <tr>
                                <td class="muted" style="font-size: 0.85rem;">"{{ linha.texto }}"</td>
                                <td style="text-align: center;">
                                    <span class="badge {{ 'badge-danger' if linha.status == 'True' else 'badge-success' }}">
                                        {{ 'Sensível' if linha.status == 'True' else 'Seguro' }}
                                    </span>
                                </td>
                                <td style="text-align: center; color: var(--risco-severo); font-weight: 600;">
                                    {{ linha.termos_sensiveis_encontrados|join(', ') if linha.termos_sensiveis_encontrados else '--' }}
                                </td>
                                <td style="text-align: center; color: var(--secondary);">
                                    {{ linha.interrogativas|join(', ') if linha.interrogativas else '--' }}
                                </td>
                                <td style="text-align: center; color: var(--primary);">
                                    {{ linha.nomes|join(', ') if linha.nomes else '--' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="analysis-result" style="margin-top: 40px;">
                <h3 style="margin-bottom: 20px; color: var(--primary);"><i class="fas fa-search-dollar"></i> Entidades e Padrões Identificados</h3>
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Tipo de Dado</th>
                            <th>Valores Extraídos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chave, valores in resposta.PADROES.items() %}
                        <tr>
                            <td style="font-weight: 600;"><i class="fas fa-fingerprint muted" style="margin-right: 8px;"></i> {{ chave }}</td>
                            <td>
                                {% if valores %}
                                    {% for valor in valores %}
                                        <span class="badge badge-danger" style="margin-right: 5px;">
                                            <i class="fas fa-exclamation-circle"></i> {{ valor }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="muted"><i class="fas fa-check-circle" style="color: var(--success);"></i> Nenhum dado detectado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

        <div style="margin-top: 50px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 30px;">
            <a href="{{ url_for('solicitacao.ver_solicitacoes') }}" class="nav-item" style="width: auto; padding: 10px 20px;">
                <i class="fas fa-arrow-left"></i> Histórico
            </a>

            <button onclick="window.print()" class="btn-primary" style="background-color: var(--secondary);">
                <i class="fas fa-print"></i> Gerar PDF
            </button>
        </div>
    </section>

    <style>
        @media print {
            .sidebar, .navbar, .nav-item, .btn-primary, footer { display: none !important; }
            body { background: white !important; padding: 0; }
            .content { width: 100% !important; margin: 0 !important; }
            .card-glow { box-shadow: none !important; border: 1px solid #eee !important; }
            .doc-table th { background: #f8f9fa !important; color: black !important; }
        }
    </style>
{% endblock %}