{% extends "base.html" %}

{% block title %}Documentação Técnica | Privacy Shield{% endblock %}

{% block main %}
    <div class="doc-container" style="display: grid; grid-template-columns: 280px 1fr; gap: 30px; align-items: start;">

        <aside class="doc-sidebar" style="position: sticky; top: 100px;">
            <div class="card-glow" style="--card-color: var(--primary); padding: 20px;">
                <div class="card-label">Documentação Oficial</div>
               <br>

                <nav class="doc-nav" style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="doc-btn active" data-target="arquitetura"><i class="fas fa-sitemap"></i> Arquitetura
                    </button>
                    <button class="doc-btn" data-target="instalacao"><i class="fas fa-rocket"></i> Deploy Rápido
                    </button>
                    <button class="doc-btn" data-target="metodologia"><i class="fas fa-brain"></i> Metodologia
                    </button>
                    <button class="doc-btn" data-target="banco-dados"><i class="fas fa-database"></i> Persistência
                        (SQLite)
                    </button>
                    <button class="doc-btn" data-target="escala-risco"><i class="fas fa-radiation"></i> Matriz de Criticidade e Risco
                    </button>
                    <button class="doc-btn" data-target="api-ref"><i class="fas fa-code"></i> API Reference</button>
                    <button class="doc-btn" data-target="comunidade"><i class="fas fa-comments"></i> Feedback</button>

                    <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                    <a href="{{ url_for('documentacao.documentacao_pdf') }}" download="Manual_Privacy_Shield.pdf"
                       class="btn-primary"
                       style="background-color: #c0392b; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; font-size: 0.9rem;">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </a>
                </nav>
            </div>
        </aside>

        <section class="doc-content-area" id="content-viewport">

            <article id="arquitetura" class="section active">
                <h2 class="section-title"><i class="fas fa-sitemap"></i> Arquitetura</h2>
                <p class="muted">
                    O <strong>Privacy Shield</strong> não é apenas um filtro; é um sentinela posicionado entre o cidadão
                    e o dado público. Desenvolvido em <strong>Flask</strong>, ele utiliza processamento assíncrono para
                    validar informações sensíveis antes que elas atinjam bases de dados públicas.
                </p>

                <div class="impact-grid" style="grid-template-columns: 1fr 1fr; margin-top: 20px;">
                    <div class="card-glow" style="--card-color: var(--secondary); padding: 15px;">
                        <div class="card-label">Backend Core</div>
                        <p class="small">Python 3.10+ com roteamento dinâmico via Blueprints para escalabilidade.</p>
                    </div>
                    <div class="card-glow" style="--card-color: #27ae60; padding: 15px;">
                        <div class="card-label">Camada de Dados</div>
                        <p class="small">SQLite 3 para persistência ágil, garantindo que o sistema seja portátil e
                            autocontido.</p>
                    </div>
                </div>
            </article>

            <article id="instalacao" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-rocket"></i> Deploy e Instalação</h2>
                <p class="muted">Configuração do ambiente para o Hackathon:</p>
                <br>
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 0.85rem; line-height: 1.6; border-left: 5px solid #27ae60;">
                    <span style="color: #6a9955;"># 1. Clonar o projeto do Hackathon</span><br>
                    git clone https://github.com/KD-Devz/Hackathon_Controle_Social_Desafio_Participa_DF.git<br>
                    cd Hackathon_Controle_Social_Desafio_Participa_DF<br><br>
                    <span style="color: #6a9955;"># 2. Ambiente isolado</span><br>
                    python -m venv venv<br>
                    source venv/bin/activate <span style="color: #808080;"># Linux/Mac</span><br>
                    .\venv\Scripts\activate <span style="color: #808080;"># Windows</span><br><br>
                    <span style="color: #6a9955;"># 3. Dependências e Execução</span><br>
                    pip install -r requirements.txt<br>
                    python app.py
                </div>
            </article>

            <article id="metodologia" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-brain"></i> Metodologia</h2>
                <p class="muted">
                    Como o sistema realmente funciona por baixo do capô? Nossa lógica de análise é dividida em três
                    camadas de filtragem:
                </p>

                <div style="margin-top: 20px; border-left: 3px solid var(--primary); padding-left: 20px;">
                    <h4 style="color: var(--primary);">1. Reconhecimento de Padrões (Regex)</h4>
                    <p class="small">Identificamos estruturas de dados como <code>(XX) XXXXX-XXXX</code> ou e-mails
                        através de expressões regulares otimizadas.</p>

                    <h4 style="color: var(--primary); margin-top: 15px;">2. Validação de Integridade (Check-Sum)</h4>
                    <p class="small">Não basta parecer um CPF. O sistema aplica o <strong>Algoritmo de Módulo
                        11</strong> para validar os dígitos verificadores, eliminando falsos positivos de números
                        aleatórios.</p>

                    <h4 style="color: var(--primary); margin-top: 15px;">3. Análise Semântica e Verbos</h4>
                    <p class="small">Utilizamos o <code>conjugador.py</code> para identificar intenções em verbos e
                        cruzar com nossa base de nomes do IBGE (via <code>recursos.py</code>) para detectar nomes
                        próprios no meio do texto.</p>
                </div>
            </article>

            <article id="banco-dados" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-database"></i> Persistência de Dados</h2>
                <p class="muted">Estrutura das tabelas no SQLite (conforme implementado em <code>banco.py</code>):</p>
                <table class="doc-table">
                    <thead>
                    <tr>
                        <th>Tabela</th>
                        <th>Campo</th>
                        <th>Função</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><code>usuarios</code></td>
                        <td><code>senha_hash</code></td>
                        <td>Armazena senhas com criptografia SHA-256.</td>
                    </tr>
                    <tr>
                        <td><code>solicitacoes</code></td>
                        <td><code>score_risco</code></td>
                        <td>Float (0-1) que define a gravidade da exposição.</td>
                    </tr>
                    <tr>
                        <td><code>comentarios</code></td>
                        <td><code>criado_em</code></td>
                        <td>Timestamp automático para trilha de auditoria.</td>
                    </tr>
                    </tbody>
                </table>
            </article>

            <article id="escala-risco" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-radiation"></i> Matriz de Criticidade e Risco</h2>
                <p class="muted">
                    O <strong>Valida Fácil</strong> utiliza um sistema de pontuação (score) para determinar se uma
                    solicitação deve ser bloqueada.
                    A pontuação varia de 0.0 a 1.0, baseada na densidade de dados sensíveis encontrados.
                </p>

                <div class="doc-table-wrapper" style="margin-top: 20px;">
                    <table class="doc-table">
                        <thead>
                        <tr>
                            <th>Nível</th>
                            <th>Score</th>
                            <th>Critério Técnico</th>
                            <th>Ação do Sistema</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><span class="badge"
                                      style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px;">Baixo</span>
                            </td>
                            <td>0.0 - 0.3</td>
                            <td>Texto limpo, apenas verbos de solicitação comuns.</td>
                            <td><strong>LIBERADO</strong></td>
                        </tr>
                        <tr>
                            <td><span class="badge"
                                      style="background: #f1c40f; color: #2c3e50; padding: 2px 8px; border-radius: 4px;">Médio</span>
                            </td>
                            <td>0.3 - 0.6</td>
                            <td>Presença de nomes próprios ou interrogativas suspeitas.</td>
                            <td><strong>REVISÃO</strong></td>
                        </tr>
                        <tr>
                            <td><span class="badge"
                                      style="background: #e67e22; color: white; padding: 2px 8px; border-radius: 4px;">Alto</span>
                            </td>
                            <td>0.6 - 0.8</td>
                            <td>Dados de contato identificados (E-mail/Telefone).</td>
                            <td><strong>BLOQUEADO</strong></td>
                        </tr>
                        <tr>
                            <td><span class="badge"
                                      style="background: #c0392b; color: white; padding: 2px 8px; border-radius: 4px;">Crítico</span>
                            </td>
                            <td>0.8 - 1.0</td>
                            <td>Documentos validados (CPF/CNPJ) via Módulo 11.</td>
                            <td><strong>BLOQUEIO TOTAL</strong></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card-glow" style="--card-color: #34495e; margin-top: 25px; padding: 20px;">
                    <h4 style="color: #3498db; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Como o Score é
                        calculado?</h4>
                    <p class="small">
                        O cálculo é incremental e não linear. A descoberta de um <strong>CPF válido</strong> gera um
                        peso significativamente maior do que um nome comum, pois representa uma violação direta e
                        confirmada à privacidade do cidadão.
                    </p>
                </div>
            </article>

            <article id="api-ref" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-code"></i> API Reference</h2>
                <p class="muted">Endpoint principal para integração com outros sistemas de transparência e controle
                    social:</p>

                <div class="card-glow" style="--card-color: #2c3e50; padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <span class="badge"
                              style="background: #2980b9; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">POST</span>
                        <code style="color: #ecf0f1; margin-left: 10px;">/analisar</code>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <strong class="small" style="color: #27ae60;"><i class="fas fa-check-circle"></i> Exemplo de
                            Payload Válido (Aprovado):</strong>
                        <pre style="background: #1a1a1a; color: #f8f8f2; padding: 15px; border-radius: 5px; font-size: 0.8rem; margin-top: 5px; border-left: 4px solid #27ae60;">
{
  "texto": "Solicito a listagem de gastos com merenda escolar no mês de Janeiro de 2026.",
  "origem": "portal-transparencia"

                        </pre>
                        <br>
                        <strong class="small" style="color: #27ae60;">Resposta do Sistema (JSON):</strong>
                        <pre style="background: #1a1a1a; color: #a6e22e; padding: 15px; border-radius: 5px; font-size: 0.8rem; margin-top: 5px;">
{
  "status": "VALIDO",
  "score": 0.05,
  "alertas": [],
  "sugestao": "Solicitação em conformidade. Proceder com o protocolo."
}
                        </pre>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #3e4e5e; margin: 20px 0;">

                    <div>
                        <strong class="small" style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i>
                            Exemplo de Payload Inválido (Risco):</strong>
                        <pre style="background: #1a1a1a; color: #f8f8f2; padding: 15px; border-radius: 5px; font-size: 0.8rem; margin-top: 5px; border-left: 4px solid #e74c3c;">
{
  "texto": "Preciso dos dados do servidor CPF 123.456.789-00.",
  "origem": "web-anonimo"
}
                        </pre>
                        <br>
                        <strong class="small" style="color: #e74c3c;">Resposta do Sistema (JSON):</strong>
                        <pre style="background: #1a1a1a; color: #f92672; padding: 15px; border-radius: 5px; font-size: 0.8rem; margin-top: 5px;">
{
  "status": "BLOQUEADO",
  "score": 0.98,
  "alertas": ["Documento CPF detectado (Módulo 11 confirmado)"],
  "sugestao": "Remover dados identificáveis antes do envio."
}
                        </pre>
                    </div>
                </div>
            </article>

            <article id="comunidade" class="section" style="display: none;">
                <h2 class="section-title"><i class="fas fa-comments"></i> Central de Feedback</h2>

                <div class="card-glow"
                     style="--card-color: var(--secondary); padding: 25px; margin-bottom: 30px; border: 1px solid #e1e8ed; background: #fff; border-radius: 12px;">
                    <p class="small" style="color: #64748b; margin-bottom: 15px;">
                        Contribua para a evolução do <strong>Valida Fácil</strong>.
                    </p>

                    <form method="POST" action="{{ url_for('documentacao.comentar_documentacao') }}#comunidade">
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="input-group">
                                <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 5px; text-transform: uppercase;">Nome:</label>
                                <input type="text" name="nome" placeholder="Ex: Cabo Calebe" required
                                       style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem;">
                            </div>
                        </div>

                        <div class="input-group">
                            <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 5px; text-transform: uppercase;">Sua
                                Contribuição:</label>
                            <textarea name="comentario" placeholder="Descreva sua dúvida ou sugestão..." required
                                      style="width: 100%; height: 90px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <button type="submit" class="btn-primary"
                                style="margin-top: 15px; background: #1e293b; color: white; padding: 12px 25px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fas fa-paper-plane"></i> PUBLICAR
                        </button>
                    </form>
                </div>

                <div class="social-feed">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <div style="height: 2px; background: #e2e8f0; flex-grow: 1;"></div>
                        <span style="font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;">Discussões da Comunidade</span>
                        <div style="height: 2px; background: #e2e8f0; flex-grow: 1;"></div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        {% for c in comentarios %}
                            <div class="comment-card"
                                 style="background: white; border-radius: 10px; padding: 18px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; gap: 15px;">
                                    <div style="width: 42px; height: 42px; background: linear-gradient(135deg, #3b82f6, #1e40af); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem; flex-shrink: 0;">
                                        {{ (c.nome[0] if c.nome else 'U') | upper }}
                                    </div>

                                    <div style="flex-grow: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                            <strong style="color: #1e293b; font-size: 0.95rem;">{{ c.nome }}</strong>
                                            <span style="font-size: 0.7rem; color: #94a3b8;">
                                    <i class="far fa-clock"></i>
                                                {% if c.criado_em is string %}
                                                    {{ c.criado_em }}
                                                {% elif c.criado_em %}
                                                    {{ c.criado_em.strftime('%d/%m/%Y %H:%M') }}
                                                {% else %}
                                                    Agora
                                                {% endif %}
                                </span>
                                        </div>

                                        <p style="color: #475569; font-size: 0.88rem; margin: 8px 0; line-height: 1.5; text-align: justify;">
                                            {{ c.comentario }}
                                        </p>

                                        <div style="display: flex; gap: 20px; margin-top: 10px; border-top: 1px solid #f1f5f9; padding-top: 10px;">
                                <span class="btn-like" onclick="simularCurtida(this)"
                                      style="color: #64748b; font-size: 0.75rem; cursor: pointer; font-weight: 600; transition: 0.2s;">
                                    <i class="fas fa-thumbs-up"></i> Útil (<span class="like-count">0</span>)
                                </span>
                                            <span onclick="simularResposta('{{ c.nome }}')"
                                                  style="color: #64748b; font-size: 0.75rem; cursor: pointer;">
                                    <i class="fas fa-reply"></i> Responder
                                </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px; border: 2px dashed #e2e8f0;">
                                <i class="fas fa-comments-slash"
                                   style="font-size: 2rem; color: #cbd5e1; margin-bottom: 10px;"></i>
                                <p style="color: #94a3b8; font-size: 0.9rem;">Ainda não há discussões técnicas. Seja o
                                    primeiro a contribuir!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </article>

        </section>
    </div>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --text-muted: #7f8c8d;
        }

        .doc-btn {
            background: transparent;
            border: none;
            padding: 12px;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            width: 100%;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .doc-btn:hover {
            background: #f8f9fa;
            color: var(--primary);
        }

        .doc-btn.active {
            background: var(--primary);
            color: white;
        }

        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .doc-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #eee;
        }

        .doc-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
    </style>

{% endblock %}

{% block scripts %}
    <script>
        // Função para trocar de aba
        function switchTab(targetId) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('active'));

            const targetSection = document.getElementById(targetId);
            const targetBtn = document.querySelector(`[data-target="${targetId}"]`);

            if (targetSection && targetBtn) {
                targetSection.style.display = 'block';
                targetBtn.classList.add('active');
            }
        }

        // Navegação via botões da Sidebar
        document.querySelectorAll('.doc-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-target');
                switchTab(target);
                // Atualiza a URL sem recarregar a página (opcional, mas profissional)
                window.history.pushState(null, null, `#${target}`);
            });
        });

        // LÓGICA DE PERSISTÊNCIA: Executa ao carregar a página
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                switchTab(hash);
                // Se for comunidade, rola até o feed
                if (hash === 'comunidade') {
                    setTimeout(() => {
                        document.getElementById('comunidade').scrollIntoView({behavior: 'smooth'});
                    }, 100);
                }
            }
        });

        // Funções de Interatividade Social
        function simularCurtida(el) {
            const count = el.querySelector('.like-count');
            let current = parseInt(count.innerText);
            if (!el.classList.contains('liked')) {
                count.innerText = current + 1;
                el.style.color = "#3b82f6";
                el.classList.add('liked');
            } else {
                count.innerText = current - 1;
                el.style.color = "#64748b";
                el.classList.remove('liked');
            }
        }

        function simularResposta(nome) {
            const txt = document.querySelector('textarea[name="comentario"]');
            txt.value = `@${nome} `;
            txt.focus();
            document.getElementById('comunidade').scrollIntoView({behavior: 'smooth'});
        }


        // Simulação de Curtida
        function simularCurtida(el) {
            const count = el.querySelector('.like-count');
            let current = parseInt(count.innerText);
            if (!el.classList.contains('liked')) {
                count.innerText = current + 1;
                el.style.color = "#3b82f6";
                el.classList.add('liked');
            } else {
                count.innerText = current - 1;
                el.style.color = "#64748b";
                el.classList.remove('liked');
            }
        }

        // Simulação de Resposta
        function simularResposta(nome) {
            const txt = document.querySelector('textarea[name="comentario"]');
            txt.value = `@${nome} `;
            txt.focus();
            window.scrollTo({top: document.querySelector('form').offsetTop - 120, behavior: 'smooth'});
        }
    </script>
{% endblock %}