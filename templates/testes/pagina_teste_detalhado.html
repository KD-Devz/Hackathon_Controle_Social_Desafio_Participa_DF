{% extends "base.html" %}

{% block title %}Relatório de Auditoria #{{ id }}{% endblock %}

{% block main %}
    <section class="content">
        <div style="text-align:center; margin-bottom:40px;">
            <span class="badge" style="background-color: var(--primary); color: white; padding: 8px 18px; border-radius: 20px;">
                Protocolo e-SIC #{{ id }}
            </span>
            <h2 style="color: var(--primary); font-weight: 700; margin-top: 15px;">Relatório de Auditoria de Privacidade</h2>
        </div>

        <div class="card-glow" style="--card-color: var(--primary); margin-bottom: 30px;">
            <div class="card-label">Conteúdo Analisado</div>
            <p style="font-style: italic; font-size: 1.05rem; line-height: 1.8; color: var(--text-main); background: #fcfcfc; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                "{{ texto }}"
            </p>
        </div>

        {% if resposta %}
            {% set is_risco = resposta.STATUS == True %}
            <div style="padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 35px;
                    background-color: {{ '#fff5f5' if is_risco else '#f0fff4' }};
                    border: 2px solid {{ 'var(--risco-severo)' if is_risco else 'var(--success)' }};">

                <h3 style="margin: 0; color: {{ 'var(--risco-severo)' if is_risco else 'var(--success)' }}; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    {% if is_risco %}
                        <i class="fas fa-exclamation-triangle"></i> RISCO DETECTADO
                    {% else %}
                        <i class="fas fa-shield-check"></i> CONTEÚDO SEGURO
                    {% endif %}
                </h3>
                <p class="muted" style="margin-top: 10px; font-weight: 500;">
                    {{ 'Identificamos padrões que violam a política de privacidade (LGPD).' if is_risco else 'Esta solicitação está em conformidade com as normas de transparência ativa.' }}
                </p>
            </div>

            <div class="analysis-result">
                <h3 style="margin: 25px 0 20px; color: var(--primary);">
                    <i class="fas fa-tasks"></i> Indicadores de Risco
                </h3>

                <div class="impact-grid">

                    {# 1. Card de Criticidade (Destaque Principal) #}
                    {% set cor_risco = '#2baea9' if resposta.CRITICIDADE_NORM <= 0.2
                                  else '#f1c40f' if resposta.CRITICIDADE_NORM <= 0.4
                                  else '#e67e22' if resposta.CRITICIDADE_NORM <= 0.6
                                  else '#ed2131' %}

                    <div class="card-glow" style="--card-color: {{ cor_risco }};">
                        <div class="card-label">Grau de Criticidade</div>
                        <div class="card-value">{{ resposta.ADJETIVO }}</div>
                        <div class="card-icon-float">
                            <i class="fas {% if resposta.CRITICIDADE_NORM > 0.6 %}fa-biohazard{% else %}fa-check-double{% endif %}"></i>
                        </div>

                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.CRITICIDADE_NORM * 100)|round }}%;"></div>
                        </div>
                        <div class="card-footer-info">
                            <span>Índice: {{ (resposta.CRITICIDADE_NORM * 100)|round(1) }}%</span>
                            <span>Bruto: {{ resposta.CRITICIDADE }}</span>
                        </div>
                    </div>

                    {# 2. Linearidade #}
                    <div class="card-glow" style="--card-color: var(--crit-linearidade);">
                        <div class="card-label">Linearidade</div>
                        <div class="card-value">{{ resposta.LINEARIDADE }}</div>
                        <div class="card-icon-float"><i class="fas fa-stream"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.LINEARIDADE * 10) if resposta.LINEARIDADE < 10 else 100 }}%;"></div>
                        </div>
                    </div>

                    {# 3. Identificadores #}
                    <div class="card-glow" style="--card-color: var(--crit-identificadores);">
                        <div class="card-label">Identificadores</div>
                        <div class="card-value">{{ resposta.IDENTIFICADORES }}</div>
                        <div class="card-icon-float"><i class="fas fa-fingerprint"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.IDENTIFICADORES * 20) if resposta.IDENTIFICADORES < 5 else 100 }}%;"></div>
                        </div>
                    </div>

                    {# 4. Exigências #}
                    <div class="card-glow" style="--card-color: var(--crit-exigencias);">
                        <div class="card-label">Exigências</div>
                        <div class="card-value">{{ resposta.EXIGENCIAS }}</div>
                        <div class="card-icon-float"><i class="fas fa-gavel"></i></div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ (resposta.EXIGENCIAS * 5) if resposta.EXIGENCIAS < 20 else 100 }}%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="analysis-result" style="margin-top: 40px;">
                <h3 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-microscope"></i> Detalhamento Técnico
                </h3>
                <div style="overflow-x: auto;">
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Texto da Linha</th>
                                <th style="text-align: center;">Status</th>
                                <th style="text-align: center;">Termos Sensíveis</th>
                                <th style="text-align: center;">Dúvidas</th>
                                <th style="text-align: center;">Nomes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for linha in resposta.linhas %}
                            <tr>
                                <td class="muted" style="font-size: 0.85rem;">"{{ linha.texto }}"</td>
                                <td style="text-align: center;">
                                    <span class="badge {{ 'badge-danger' if linha.status == True else 'badge-success' }}">
                                        {{ 'Sensível' if linha.status == True else 'Seguro' }}
                                    </span>
                                </td>
                                <td style="text-align: center; color: var(--risco-severo); font-weight: 600;">
                                    {{ linha.termos_sensiveis_encontrados|join(', ') if linha.termos_sensiveis_encontrados else '--' }}
                                </td>
                                <td style="text-align: center; color: var(--secondary);">
                                    {{ linha.interrogativas|join(', ') if linha.interrogativas else '--' }}
                                </td>
                                <td style="text-align: center; color: var(--crit-identificadores);">
                                    {{ linha.nomes|join(', ') if linha.nomes else '--' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="analysis-result" style="margin-top: 40px;">
                <h3 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-search"></i> Extração de Entidades Sensíveis
                </h3>
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Tipo de Dado</th>
                            <th>Valores Detectados</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for chave, valores in resposta.PADROES.items() %}
                        <tr>
                            <td style="font-weight: 600;"><i class="fas fa-tag muted" style="margin-right: 8px;"></i> {{ chave }}</td>
                            <td>
                                {% if valores %}
                                    {% for valor in valores %}
                                        <span class="badge badge-danger" style="margin-right: 5px;">
                                            <i class="fas fa-eye-slash"></i> {{ valor }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="muted"><i class="fas fa-check-circle" style="color: var(--success);"></i> Nenhum dado detectado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% else %}
            <div style="text-align: center; padding: 60px;">
                <i class="fas fa-inbox muted" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <p class="muted">Nenhum dado de análise disponível.</p>
            </div>
        {% endif %}

        <div style="margin-top: 50px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 30px;">
            <a href="{{ url_for('lista_de_testes.pagina_testes') }}" class="nav-item" style="width: auto; padding: 10px 20px;">
                <i class="fas fa-arrow-left"></i> Voltar ao Histórico
            </a>

            <button onclick="window.print()" class="btn-primary" style="background-color: var(--text-main);">
                <i class="fas fa-print"></i> Exportar Relatório (PDF)
            </button>
        </div>
    </section>
{% endblock %}